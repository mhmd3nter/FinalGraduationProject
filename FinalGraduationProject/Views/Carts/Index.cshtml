@model IEnumerable<FinalGraduationProject.Models.CartItem>
@{
    ViewData["Title"] = "Shopping Cart";
    var subtotal = Model.Where(i => i.Product != null).Sum(i => i.Product.Price * i.Quantity);
    var tax = subtotal * 0.14m;
    var shipping = subtotal > 100 ? 0 : 10;
    var total = subtotal + tax + shipping;
    var totalItems = Model.Sum(i => i.Quantity);
}

<main class="page">
    <section class="shopping-cart py-5" style="background:#f8f9fa;">
        <div class="container">
            <div class="block-heading text-center mb-5">
                <h2 class="fw-bold text-primary">@ViewData["Title"]</h2>
                <p class="text-muted">Adjust your items or remove what you don’t need.</p>
            </div>
            <div class="row">
                <!-- Items -->
                <div class="col-md-12 col-lg-8">
                    <div class="items">
                        @if (!Model.Any())
                        {
                            <div class="alert alert-info text-center">
                                Your cart is empty.
                                <a href="@Url.Action("Index", "Products")" class="alert-link">Continue shopping</a>
                            </div>
                        }
                        else
                        {
                            @foreach (var item in Model)
                            {
                                var stock = item.ProductSize?.Quantity ?? 0;
                                <div class="product mb-3 p-3 bg-white shadow-sm rounded">
                                    <div class="row align-items-center">
                                        <div class="col-md-3">
                                            <img src="@Url.Content(item.Product.ImageUrl)" alt="@item.Product.Name" class="img-fluid">
                                        </div>
                                        <div class="col-md-5">
                                            <h5 class="mb-1">@item.Product?.Name</h5>
                                            <ul class="list-unstyled small text-muted mb-2">
                                                <li>Brand: @item.Product?.Brand?.Name</li>
                                                <li>Color: @item.Product?.Color</li>
                                                <li>Size: @item.ProductSize?.Size?.Name</li>
                                                <li>@item.Product?.Description</li>
                                            </ul>
                                            <div class="fw-bold text-primary">
                                                $@(item.Product?.Price ?? 0)
                                            </div>
                                        </div>

                                        <!-- Quantity Controls -->
                                        <div class="col-md-2 text-center">
                                            <div class="d-flex justify-content-center align-items-center">
                                                <form asp-controller="Carts" asp-action="UpdateQuantity" method="post" class="d-inline">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="cartItemId" value="@item.Id" />
                                                    <button type="submit" name="change" value="-1"
                                                            class="btn btn-outline-danger btn-sm px-2"
                                                            style="border-radius:50%;"
                                                            @(item.Quantity <= 1 ? "disabled" : "")>
                                                        <i class="fas fa-minus"></i>
                                                    </button>
                                                </form>

                                                <span class="mx-3 fw-bold fs-5">@item.Quantity</span>

                                                <form asp-controller="Carts" asp-action="UpdateQuantity" method="post" class="d-inline">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="cartItemId" value="@item.Id" />
                                                    <button type="submit" name="change" value="1"
                                                            class="btn btn-outline-success btn-sm px-2"
                                                            style="border-radius:50%;"
                                                            @(stock > 0 && item.Quantity < stock ? "" : "disabled")>
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>

                                        <!-- Remove -->
                                        <div class="col-md-2 text-center">
                                            <form asp-controller="Carts" asp-action="RemoveFromCart" method="post">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="cartItemId" value="@item.Id" />
                                                <button type="submit"
                                                        class="btn btn-outline-danger w-100 mt-2"
                                                        style="border-radius:8px;">
                                                    <i class="fas fa-trash-alt"></i> Remove
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <!-- Summary -->
                <div class="col-md-12 col-lg-4">
                    <div class="summary bg-white p-4 rounded shadow-sm">
                        <h4 class="fw-bold text-success mb-4">Order Summary</h4>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Items (@totalItems)</span>
                            <span>$@subtotal.ToString("F2")</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax (14%)</span>
                            <span>$@tax.ToString("F2")</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping</span>
                            <span>@(shipping == 0 ? "FREE" : $"${shipping:F2}")</span>
                        </div>
                        <hr />
                        <div class="d-flex justify-content-between fw-bold h5 text-primary">
                            <span>Total:</span>
                            <span>$@total.ToString("F2")</span>
                        </div>
                        <form asp-action="Checkout" method="post" class="mt-3">
                            @Html.AntiForgeryToken()
                            <button type="submit"
                                    class="btn btn-success btn-lg w-100"
                                    @(subtotal <= 0 ? "disabled" : "")>
                                <i class="fas fa-credit-card"></i> Checkout
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
