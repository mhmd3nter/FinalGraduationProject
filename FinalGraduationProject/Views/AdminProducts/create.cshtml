@model FinalGraduationProject.Models.Product
@{
    ViewData["Title"] = "Add Product";
    var sizes = ViewBag.Sizes as List<FinalGraduationProject.Models.Size>;
}

<div class="container py-5">
    <h2 class="fw-bold text-primary mb-4">@ViewData["Title"]</h2>
    
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (ViewBag.Errors != null && ((List<string>)ViewBag.Errors).Any())
    {
        <div class="alert alert-danger">
            <ul class="mb-0">
                @foreach (var err in (List<string>)ViewBag.Errors)
                {
                    <li>@err</li>
                }
            </ul>
        </div>
    }

    <form asp-action="Create" method="post" enctype="multipart/form-data" class="shadow rounded bg-white p-4">
        @Html.AntiForgeryToken()

        <div class="row">
            <div class="col-md-6">
                <!-- Product Name -->
                <div class="mb-3">
                    <label asp-for="Name" class="form-label">Product Name *</label>
                    <input asp-for="Name" class="form-control" placeholder="Enter product name" required />
                    <span asp-validation-for="Name" class="text-danger"></span>
                </div>

                <!-- Brand -->
                <div class="mb-3">
                    <label asp-for="BrandId" class="form-label">Brand *</label>
                    <select asp-for="BrandId" class="form-select" asp-items="ViewBag.BrandId" required>
                        <option value="">-- Select Brand --</option>
                    </select>
                    <span asp-validation-for="BrandId" class="text-danger"></span>
                </div>

                <!-- Category -->
                <div class="mb-3">
                    <label asp-for="CategoryId" class="form-label">Category *</label>
                    <select asp-for="CategoryId" class="form-select" asp-items="ViewBag.CategoryId" required>
                        <option value="">-- Select Category --</option>
                    </select>
                    <span asp-validation-for="CategoryId" class="text-danger"></span>
                </div>

                <!-- Price -->
                <div class="mb-3">
                    <label asp-for="Price" class="form-label">Price ($) *</label>
                    <input asp-for="Price" class="form-control" type="number" step="0.01" min="0" placeholder="0.00" required />
                    <span asp-validation-for="Price" class="text-danger"></span>
                </div>

                <!-- Gender -->
                <div class="mb-3">
                    <label asp-for="Gender" class="form-label">Gender *</label>
                    <select asp-for="Gender" class="form-select" required>
                        <option value="">-- Select Gender --</option>
                        <option value="Men">Men</option>
                        <option value="Women">Women</option>
                        <option value="Unisex">Unisex</option>
                        <option value="Kids">Kids</option>
                    </select>
                    <span asp-validation-for="Gender" class="text-danger"></span>
                </div>
            </div>

            <div class="col-md-6">
                <!-- Color -->
                <div class="mb-3">
                    <label asp-for="Color" class="form-label">Color *</label>
                    <input asp-for="Color" class="form-control" placeholder="e.g., Black, White, Red" required />
                    <span asp-validation-for="Color" class="text-danger"></span>
                </div>

                <!-- Description -->
                <div class="mb-3">
                    <label asp-for="Description" class="form-label">Description</label>
                    <textarea asp-for="Description" class="form-control" rows="3" placeholder="Enter product description"></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>

                <!-- Image Upload -->
                <div class="mb-3">
                    <label class="form-label">Product Image</label>
                    <input type="file" name="ImageFile" class="form-control" accept="image/*" />
                    <div class="form-text">Upload a product image (JPG, PNG, GIF)</div>
                </div>

                <!-- Active Status -->
                <div class="mb-3 form-check">
                    <input asp-for="IsActive" class="form-check-input" type="checkbox" checked />
                    <label asp-for="IsActive" class="form-check-label">Product is Active</label>
                </div>
            </div>
        </div>

        <!-- Sizes Section -->
        <div class="row mt-4">
            <div class="col-12">
                <h5 class="text-primary mb-3">Available Sizes & Stock *</h5>
                <p class="text-muted">Select the sizes available for this product and specify stock quantities:</p>
                
                @if (sizes != null && sizes.Any())
                {
                    <div class="row">
                        @for (int i = 0; i < sizes.Count; i++)
                        {
                            <div class="col-md-3 col-sm-4 col-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <div class="form-check mb-2">
                                            <input type="checkbox" 
                                                   class="form-check-input size-checkbox" 
                                                   name="SizeQuantities[@sizes[i].Id].IsSelected" 
                                                   value="true" 
                                                   id="size_@sizes[i].Id" />
                                            <input type="hidden" name="SizeQuantities[@sizes[i].Id].SizeId" value="@sizes[i].Id" />
                                            <input type="hidden" name="SizeQuantities[@sizes[i].Id].IsSelected" value="false" />
                                            <label class="form-check-label fw-bold" for="size_@sizes[i].Id">
                                                Size @sizes[i].Name
                                            </label>
                                        </div>
                                        <div class="quantity-input" style="display: none;">
                                            <label class="form-label small">Quantity:</label>
                                            <input type="number" 
                                                   name="SizeQuantities[@sizes[i].Id].Quantity" 
                                                   class="form-control form-control-sm" 
                                                   min="0" 
                                                   value="0" 
                                                   placeholder="0" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> No sizes found in the database.
                    </div>
                }
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="d-flex justify-content-end mt-4 pt-3 border-top">
            <a asp-action="Index" class="btn btn-secondary btn-lg me-3">
                <i class="fas fa-times"></i> Cancel
            </a>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save"></i> Save Product
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        // Handle size selection and quantity inputs
        document.addEventListener('DOMContentLoaded', function() {
            const sizeCheckboxes = document.querySelectorAll('.size-checkbox');
            
            sizeCheckboxes.forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    const quantityDiv = this.closest('.card-body').querySelector('.quantity-input');
                    const quantityInput = quantityDiv.querySelector('input[type="number"]');
                    
                    if (this.checked) {
                        quantityDiv.style.display = 'block';
                        quantityInput.value = '10'; // Default quantity
                        quantityInput.required = true;
                    } else {
                        quantityDiv.style.display = 'none';
                        quantityInput.value = '0';
                        quantityInput.required = false;
                    }
                });
            });

            // Form validation
            const form = document.querySelector('form');
            form.addEventListener('submit', function(e) {
                const selectedSizes = document.querySelectorAll('.size-checkbox:checked');
                
                if (selectedSizes.length === 0) {
                    e.preventDefault();
                    alert('Please select at least one size for the product.');
                    return false;
                }

                // Check if all selected sizes have quantities > 0
                let hasValidQuantities = true;
                selectedSizes.forEach(function(checkbox) {
                    const quantityInput = checkbox.closest('.card-body').querySelector('input[type="number"]');
                    if (!quantityInput.value || parseInt(quantityInput.value) <= 0) {
                        hasValidQuantities = false;
                    }
                });

                if (!hasValidQuantities) {
                    e.preventDefault();
                    alert('Please enter valid quantities (greater than 0) for all selected sizes.');
                    return false;
                }
            });
        });
    </script>
    
    <style>
        .card {
            transition: all 0.2s ease-in-out;
        }
        .card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .size-checkbox:checked + input + input + label {
            color: #0d6efd;
            font-weight: bold;
        }
    </style>
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
