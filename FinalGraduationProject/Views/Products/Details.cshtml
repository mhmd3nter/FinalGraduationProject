@model FinalGraduationProject.Models.Product

@{
    ViewData["Title"] = Model.Name;
    var totalStock = Model.ProductSizes.Sum(ps => ps.Quantity); // ✅ إجمالي الكمية
}

<main class="page py-5">
    <div class="container products-wrapper p-4">
        <div class="row g-5 align-items-center">
            <!-- 🖼️ صورة المنتج -->
            <div class="col-md-5">
                <div class="border rounded shadow-sm bg-white p-2 stylish-card scroll-animate">
                    <img src="@Url.Content(Model.ImageUrl)"
                         alt="@Model.Name"
                         class="img-fluid rounded product-image"
                         style="object-fit:cover; max-height:450px; width:100%;" />
                </div>
            </div>

            <!-- 📋 تفاصيل المنتج -->
            <div class="col-md-7 scroll-animate">
                <h2 class="fw-bold mb-3 animate-title text-primary">@Model.Name</h2>
                <p class="text-muted">@Model.Description</p>

                <ul class="list-unstyled mb-4">
                    <li><strong>Brand:</strong> @Model.Brand?.Name</li>
                    <li><strong>Category:</strong> @Model.Category?.Name</li>
                    <li><strong>Color:</strong> @Model.Color</li>
                    <li><strong>Total Stock:</strong> @totalStock</li> <!-- ✅ العدد الكلي -->
                </ul>

                <!-- 💲 السعر -->
                <h3 class="mb-4 fw-bold text-primary">$@Model.Price</h3>

                <!-- 🛒 Add to Cart -->
                @if (!User.IsInRole("Admin"))
                {
                    <form asp-controller="Carts" asp-action="AddToCart" method="post"
                          class="border p-3 bg-light rounded shadow-sm">
                        @Html.AntiForgeryToken()

                        <input type="hidden" name="productId" value="@Model.Id" />

                        <!-- ✅ اختيار المقاس -->
                        <div class="mb-3">
                            <label for="productSizeId" class="form-label fw-semibold">Select Size</label>
                            <select id="productSizeId" name="productSizeId"
                                    class="form-select shadow-sm" required>
                                <option value="">Choose size</option>
                                @foreach (var ps in Model.ProductSizes)
                                {
                                    if (ps.Quantity > 0)
                                    {
                                        <option value="@ps.Id" data-max="@ps.Quantity">
                                            @ps.Size.Name (@ps.Quantity in stock)
                                        </option>
                                    }
                                    else
                                    {
                                        <option value="@ps.Id" disabled>@ps.Size.Name (Out of Stock)</option>
                                    }
                                }
                            </select>

                            <div id="sizeError" class="text-danger mt-1" style="display:none;">
                                * Please select a size in stock
                            </div>
                        </div>

                        <!-- ✅ الكمية -->
                        <div class="d-flex align-items-center mb-3">
                            <button type="button" class="btn btn-outline-secondary" onclick="changeQty(-1)">-</button>
                            <input type="number" id="quantity" name="quantity" value="1" min="1"
                                   class="form-control text-center mx-2" style="width:70px;">
                            <button type="button" class="btn btn-outline-secondary" onclick="changeQty(1)">+</button>
                        </div>

                        <!-- ✅ زر الإضافة -->
                        <button type="submit" class="btn btn-glow w-100" id="addToCartBtn">
                            <i class="fas fa-shopping-cart me-2"></i> Add to Cart
                        </button>
                    </form>
                }

                <a asp-action="Index" class="btn btn-outline-secondary mt-3">
                    <i class="fas fa-arrow-left me-1"></i> Back to Products
                </a>
            </div>
        </div>
    </div>
</main>

<!-- ✅ JavaScript -->
<script>
    function changeQty(delta) {
        let qtyInput = document.getElementById("quantity");
        let max = parseInt(qtyInput.max) || 1;
        let current = parseInt(qtyInput.value) || 1;

        current += delta;
        if (current < 1) current = 1;
        if (current > max) current = max; // ✅ مايزودش عن المتاح
        qtyInput.value = current;
    }

    document.addEventListener("DOMContentLoaded", () => {
        const sizeSelect = document.getElementById("productSizeId");
        const qtyInput = document.getElementById("quantity");

        sizeSelect.addEventListener("change", function () {
            const selectedOption = this.options[this.selectedIndex];
            const max = selectedOption.getAttribute("data-max");

            if (max) {
                qtyInput.max = max;       // ✅ تحديد الحد الأقصى
                qtyInput.value = 1;       // يرجع للقيمة 1 عند اختيار مقاس
            }
        });

        // ✅ لو كتب رقم أكبر من المتاح بإيده
        qtyInput.addEventListener("input", function () {
            let max = parseInt(this.max) || 1;
            let val = parseInt(this.value) || 1;

            if (val < 1) val = 1;
            if (val > max) val = max;
            this.value = val;
        });

        // ✅ نفس كود الإنيميشن
        const elements = document.querySelectorAll(".scroll-animate");
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add("show");
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.2 });
        elements.forEach(el => observer.observe(el));
    });

    // ✅ التحقق من اختيار مقاس
    document.getElementById('addToCartBtn').addEventListener('click', function (e) {
        const sizeSelect = document.getElementById('productSizeId');
        const sizeError = document.getElementById('sizeError');

        if (!sizeSelect.value || sizeSelect.options[sizeSelect.selectedIndex].disabled) {
            e.preventDefault();
            sizeError.style.display = "block";
            sizeSelect.focus();
            return;
        } else {
            sizeError.style.display = "none";
        }
    });
</script>

<!-- ✅ CSS -->
<style>
    main.page {
        background: #eef1f6;
        color: #212529;
    }

    .products-wrapper {
        background: #ffffff;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        border-radius: 1rem;
        padding: 2rem;
    }

    .stylish-card {
        background: #ffffff;
        transition: all 0.4s ease;
        border: 1px solid rgba(0,0,0,0.05);
    }

        .stylish-card:hover {
            transform: translateY(-10px) scale(1.03);
            background: #ffffff;
            box-shadow: 0 12px 30px rgba(0, 123, 255, 0.25), 0 0 18px rgba(13, 110, 253, 0.15);
        }

    .animate-title {
        animation: fadeInDown 1s ease-in-out forwards;
        text-shadow: 0 0 8px rgba(13,110,253,0.3);
        color: #0d6efd;
    }

    @@keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .btn-glow {
        background: #fd7e14;
        border: none;
        color: #fff;
        font-weight: 600;
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
    }

        .btn-glow:hover {
            background: linear-gradient(45deg, #fd7e14, #ffae42);
            box-shadow: 0 0 15px rgba(253, 126, 20, 0.5);
            transform: translateY(-2px);
            color: #fff !important;
        }

    .scroll-animate {
        opacity: 0;
        transform: translateY(50px) scale(0.95);
        transition: all 0.9s ease;
    }

        .scroll-animate.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
</style>

<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
